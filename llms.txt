# moku-instrument-forge-vhdl

Shared VHDL utilities for Moku custom instrument development with CocoTB progressive testing.

## Quick Reference

**What:** Reusable VHDL components with token-efficient CocoTB tests
**Use:** Git submodule in forge-based projects
**Test:** CocoTB + GHDL filter (P1 tests <20 lines, 98% noise reduction)

## Structure

```
vhdl/
├── packages/       # volo_lut_pkg (+ tests), volo_voltage_pkg, volo_common_pkg
├── utilities/      # forge_util_clk_divider (+ tests), threshold trigger
├── debugging/      # fsm_observer (real-time FSM monitoring)
└── loader/         # volo_bram_loader (BRAM initialization)

scripts/            # ghdl_output_filter.py (THE secret weapon)
tests/              # CocoTB progressive testing infrastructure
docs/               # Testing standards, guides, patterns
```

## Key Components (With CocoTB Tests)

**forge_util_clk_divider** - Programmable clock divider
- P1 tests: 3 (reset, divide-by-2, enable)
- Output: ~20 lines, ~50 tokens

**volo_lut_pkg** - Look-up table utilities
- P1 tests: 4 (constants, conversions, index, boundary)
- Output: ~15 lines, ~70 tokens

**fsm_observer** - Export FSM state to Moku registers (no tests yet)
**volo_voltage_pkg** - Voltage conversion utilities (no tests yet)
**volo_bram_loader** - BRAM initialization (no tests yet)

## Testing (NEW!)

```bash
# Run P1 tests (LLM-optimized, <20 lines)
uv run python tests/run.py forge_util_clk_divider

# Run P2 tests (full validation)
TEST_LEVEL=P2_INTERMEDIATE uv run python tests/run.py forge_util_clk_divider

# List all tests
uv run python tests/run.py --list
```

## Integration Pattern

Used as submodule in `moku-instrument-forge-mono-repo`:

```bash
git submodule add https://github.com/sealablab/moku-instrument-forge-vhdl.git libs/forge-vhdl
```

VHDL files compiled with GHDL via CocoTB test infrastructure.

## Development

```bash
uv sync                          # Install dependencies
uv run python tests/run.py --all # Run all tests (P1)
```

## For More Details

See CLAUDE.md for testing standards, component patterns, design rationale.
See docs/ for comprehensive testing guides.

---

**Version:** 1.1.0 (added CocoTB testing)
**License:** MIT
**Origin:** Extracted from EZ-EMFI project
